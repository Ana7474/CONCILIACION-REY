Option Explicit

Public Sub BANORTE()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wbCSV As Workbook, wsCSV As Worksheet
    Dim wsDATA As Worksheet, wsCONC As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim i As Long
    Dim txt As String, pos As Long
    Dim lastRowConc As Long
    Dim shellObj As Object, saveRoot As String, savePath As String
    Dim fileName As String, fullSave As String
    Dim wbNew As Workbook
    
    ' Hojas
    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "No se encontraron las hojas (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' 1) Limpiar hojas
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear
    
    ' 2) Seleccionar archivo CSV
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Seleccionar archivo CSV"
        .Filters.Clear
        .Filters.Add "CSV UTF-8", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With
    
    ' 3) Abrir CSV como workbook
    Set wbCSV = Workbooks.Open(fileName:=filePath)
    Set wsCSV = wbCSV.Sheets(1)
    
    lastRow = wsCSV.Cells(wsCSV.Rows.Count, "A").End(xlUp).Row
    lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column
    
    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")
    
    wbCSV.Close SaveChanges:=False
    
    ' 4) En columna D: cambiar COMPRA->BUY y VENTA->SELL (hasta last row de E)
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "E").End(xlUp).Row
    For i = 2 To lastRow
        txt = UCase$(Trim$(CStr(wsDATA.Cells(i, "D").Value)))
        If txt = "COMPRA" Then
            wsDATA.Cells(i, "D").Value = "BUY"
        ElseIf txt = "VENTA" Then
            wsDATA.Cells(i, "D").Value = "SELL"
        End If
    Next i
    
    ' 5) Volcar columnas a CONCILIACIÓN
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "E").End(xlUp).Row
    If lastRow < 2 Then GoTo TidyExit
    
    wsCONC.Cells.Clear
    wsCONC.Range("A1").Value = wsDATA.Range("E1").Value
    wsCONC.Range("B1").Value = wsDATA.Range("D1").Value
    wsCONC.Range("C1").Value = "Prefijo"
    wsCONC.Range("D1").Value = wsDATA.Range("K1").Value
    wsCONC.Range("E1").Value = "Monto"
    wsCONC.Range("F1").Value = wsDATA.Range("F1").Value
    wsCONC.Range("G1").Value = wsDATA.Range("G1").Value
    wsCONC.Range("H1").Value = wsDATA.Range("H1").Value
    
    wsCONC.Range("A2").Resize(lastRow - 1).Value = wsDATA.Range("E2").Resize(lastRow - 1).Value
    wsCONC.Range("B2").Resize(lastRow - 1).Value = wsDATA.Range("D2").Resize(lastRow - 1).Value
    wsCONC.Range("D2").Resize(lastRow - 1).Value = wsDATA.Range("K2").Resize(lastRow - 1).Value
    wsCONC.Range("F2").Resize(lastRow - 1).Value = wsDATA.Range("F2").Resize(lastRow - 1).Value
    wsCONC.Range("G2").Resize(lastRow - 1).Value = wsDATA.Range("G2").Resize(lastRow - 1).Value
    wsCONC.Range("H2").Resize(lastRow - 1).Value = wsDATA.Range("H2").Resize(lastRow - 1).Value
    
    ' 6) Formatear fechas en columna G (solo la fecha, sin hora)
    lastRowConc = wsCONC.Cells(wsCONC.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRowConc
        txt = Trim$(CStr(wsCONC.Cells(i, "G").Value))
        pos = InStr(txt, " ")
        If pos > 0 Then txt = Left$(txt, pos - 1)
        If IsDate(txt) Then wsCONC.Cells(i, "G").Value = CDate(txt)
    Next i
    wsCONC.Range("G2:G" & lastRowConc).NumberFormat = "dd/mm/yyyy"
    
    ' 7) Rellenar columna C = primeros 3 caracteres de A
    For i = 2 To lastRowConc
        txt = Trim$(CStr(wsCONC.Cells(i, "A").Value))
        If Len(txt) >= 3 Then wsCONC.Cells(i, "C").Value = Left$(txt, 3)
    Next i
    
    ' 8) Rellenar columna E = D * F
    For i = 2 To lastRowConc
        If IsNumeric(wsCONC.Cells(i, "D").Value) And IsNumeric(wsCONC.Cells(i, "F").Value) Then
            wsCONC.Cells(i, "E").Value = wsCONC.Cells(i, "D").Value * wsCONC.Cells(i, "F").Value
        End If
    Next i
    
    ' 9) Guardar CONCILIACIÓN como BANORTE_yyyymmdd.xlsx en INTERMEDIARIOS
    Set shellObj = CreateObject("WScript.Shell")
    saveRoot = shellObj.SpecialFolders("MyDocuments")
    savePath = saveRoot & "\VARIOS\INTERMEDIARIOS\"
    
    If Dir(savePath, vbDirectory) = "" Then
        MsgBox "La carpeta no existe: " & vbCrLf & savePath, vbCritical
        GoTo TidyExit
    End If
    
    fileName = "BANORTE_" & Format(Date, "yyyymmdd") & ".xlsx"
    fullSave = savePath & fileName
    
    wsCONC.Copy
    Set wbNew = ActiveWorkbook
    On Error Resume Next
    wbNew.Sheets(1).Name = "Hoja1"
    On Error GoTo 0
    
    Application.DisplayAlerts = False
    wbNew.SaveAs fileName:=fullSave, FileFormat:=xlOpenXMLWorkbook
    Application.DisplayAlerts = True
    wbNew.Close SaveChanges:=False
    
    MsgBox "Proceso terminado. Archivo guardado en: " & vbCrLf & fullSave, vbInformation
    
TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub