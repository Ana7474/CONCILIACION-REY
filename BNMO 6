Option Explicit

Public Sub Import_CSV_Clean_CADSwap_FixDates_CopyAH()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wsDATA As Worksheet, wsCONC As Worksheet
    Dim wbCSV As Workbook, wsCSV As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim i As Long
    Dim r As Range, rr As Long
    Dim b As String, tmp As Variant
    Dim changed As Long
    Dim s As String, p As Long, d As Variant

    ' Get target sheets
    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0

    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "Required sheets not found (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    ' 1) Clear sheets
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear

    ' 2) Ask for CSV file
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Seleccionar archivo CSV"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With

    ' 3) Open CSV and copy to DATA
    Set wbCSV = Workbooks.Open(Filename:=filePath)
    Set wsCSV = wbCSV.Sheets(1)

    lastRow = wsCSV.Cells(wsCSV.Rows.Count, "A").End(xlUp).Row
    lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column

    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")

    wbCSV.Close SaveChanges:=False

    ' 4) Process CAD with AutoFilter (col C): swap D<->E, flip B<->S
    With wsDATA
        lastRow = .Cells(.Rows.Count, "C").End(xlUp).Row
        If lastRow >= 2 Then
            ' Pre-clean C (NBSP -> space) + TRIM + UPPER
            .Range("C2:C" & lastRow).Replace What:=Chr(160), Replacement:=" ", _
                LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False
            For i = 2 To lastRow
                If Not IsEmpty(.Cells(i, "C").Value) Then
                    .Cells(i, "C").Value = UCase$(WorksheetFunction.Trim(CStr(.Cells(i, "C").Value)))
                End If
            Next i

            If .AutoFilterMode Then .AutoFilterMode = False
            .Range("A1").CurrentRegion.AutoFilter Field:=3, Criteria1:="=CAD"

            changed = 0
            On Error Resume Next
            For Each r In .Range("A2:A" & lastRow).SpecialCells(xlCellTypeVisible).Cells
                rr = r.Row
                ' Swap D <-> E
                tmp = .Cells(rr, "D").Value
                .Cells(rr, "D").Value = .Cells(rr, "E").Value
                .Cells(rr, "E").Value = tmp
                ' Flip B <-> S
                b = UCase$(WorksheetFunction.Trim(CStr(.Cells(rr, "B").Value)))
                If b = "B" Then
                    .Cells(rr, "B").Value = "S"
                ElseIf b = "S" Then
                    .Cells(rr, "B").Value = "B"
                End If
                changed = changed + 1
            Next r
            On Error GoTo 0

            If .AutoFilterMode Then .AutoFilterMode = False
        End If
    End With

    ' 5) Remove time from columns G and H, convert to real date, format dd/mm/yyyy
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRow
        ' --- G ---
        s = CStr(wsDATA.Cells(i, "G").Value)
        s = Replace$(s, Chr$(160), " ")                 ' NBSP -> space
        s = Replace$(s, ChrW$(&H202F), " ")             ' narrow NBSP -> space
        s = Trim$(s)
        p = InStr(s, " ")
        If p = 0 Then p = InStr(s, "T")                 ' handle ISO yyyy-mm-ddT...
        If p > 0 Then s = Left$(s, p - 1)
        On Error Resume Next
        d = CDate(s)
        On Error GoTo 0
        If IsDate(d) Then
            wsDATA.Cells(i, "G").Value = DateValue(d)
        Else
            wsDATA.Cells(i, "G").Value = s              ' leave date text if not convertible
        End If

        ' --- H ---
        s = CStr(wsDATA.Cells(i, "H").Value)
        s = Replace$(s, Chr$(160), " ")
        s = Replace$(s, ChrW$(&H202F), " ")
        s = Trim$(s)
        p = InStr(s, " ")
        If p = 0 Then p = InStr(s, "T")
        If p > 0 Then s = Left$(s, p - 1)
        On Error Resume Next
        d = CDate(s)
        On Error GoTo 0
        If IsDate(d) Then
            wsDATA.Cells(i, "H").Value = DateValue(d)
        Else
            wsDATA.Cells(i, "H").Value = s
        End If
    Next i

    If lastRow >= 2 Then
        wsDATA.Range("G2:G" & lastRow).NumberFormat = "dd/mm/yyyy"
        wsDATA.Range("H2:H" & lastRow).NumberFormat = "dd/mm/yyyy"
    End If

    ' 6) Copy A:H from DATA to CONCILIACIÓN
    If lastRow >= 1 Then
        wsDATA.Range("A1:H" & lastRow).Copy
        wsCONC.Range("A1").PasteSpecial xlPasteAll
        Application.CutCopyMode = False
    End If

    MsgBox "Done. CAD rows processed: " & changed & _
           " | Time removed & dates normalized in G/H | A:H copied to CONCILIACIÓN.", vbInformation

TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub