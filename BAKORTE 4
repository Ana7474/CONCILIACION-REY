Option Explicit

Public Sub Import_CSV_UTF8_To_DATA()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wsDATA As Worksheet, wsCONC As Worksheet
    Dim wbCSV As Workbook, wsCSV As Worksheet
    Dim found As Range
    Dim lastRow As Long, lastCol As Long
    Dim gotData As Boolean
    Dim lastRowE As Long, i As Long, txt As String
    
    ' Hojas
    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0
    
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "No se encontraron las hojas (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' 1) Limpiar ambas hojas
    ClearSheetCompletely wsDATA
    ClearSheetCompletely wsCONC
    
    ' 2) Seleccionar archivo CSV
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Seleccionar archivo CSV"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With
    
    ' 3) Abrir CSV y copiar a DATA
    Set wbCSV = Workbooks.Open(Filename:=filePath)
    Set wsCSV = wbCSV.Sheets(1)
    
    gotData = False
    Set found = wsCSV.Cells.Find(What:="*", LookIn:=xlFormulas, LookAt:=xlPart, _
                                 SearchOrder:=xlByRows, SearchDirection:=xlPrevious, MatchCase:=False)
    If Not found Is Nothing Then
        lastRow = found.Row
        Set found = wsCSV.Cells.Find(What:="*", LookIn:=xlFormulas, LookAt:=xlPart, _
                                     SearchOrder:=xlByColumns, SearchDirection:=xlPrevious, MatchCase:=False)
        lastCol = found.Column
        wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")
        gotData = True
    End If
    
    wbCSV.Close SaveChanges:=False
    
    If Not gotData Then
        MsgBox "El CSV está vacío o no se detectó información.", vbExclamation
        GoTo TidyExit
    End If
    
    ' 4) Columna D: COMPRA -> BUY, VENTA -> SELL (hasta última fila según columna E)
    lastRowE = wsDATA.Cells(wsDATA.Rows.Count, "E").End(xlUp).Row
    If lastRowE >= 2 Then
        For i = 2 To lastRowE
            txt = CStr(wsDATA.Cells(i, "D").Value)
            txt = Replace$(txt, Chr$(160), " ")
            txt = Replace$(txt, ChrW$(&H202F), " ")
            txt = UCase$(Trim$(txt))
            Select Case txt
                Case "COMPRA": wsDATA.Cells(i, "D").Value = "BUY"
                Case "VENTA":  wsDATA.Cells(i, "D").Value = "SELL"
            End Select
        Next i
    End If
    
    ' 5) Mapear columnas a CONCILIACIÓN
    Dim lastRowMap As Long
    lastRowMap = wsDATA.Cells(wsDATA.Rows.Count, "E").End(xlUp).Row
    If lastRowMap < 2 Then
        MsgBox "No hay filas para copiar (columna E vacía).", vbExclamation
        GoTo TidyExit
    End If
    
    wsCONC.Cells.Clear
    
    ' Encabezados
    wsCONC.Range("A1").Value = wsDATA.Range("E1").Value   ' A <- E
    wsCONC.Range("B1").Value = wsDATA.Range("D1").Value   ' B <- D
    wsCONC.Range("C1").Value = ""                        ' vacío (no pediste nada en C)
    wsCONC.Range("D1").Value = wsDATA.Range("K1").Value   ' D <- K
    wsCONC.Range("E1").Value = ""                        ' vacío
    wsCONC.Range("F1").Value = wsDATA.Range("F1").Value   ' F <- F
    wsCONC.Range("G1").Value = wsDATA.Range("G1").Value   ' G <- G
    wsCONC.Range("H1").Value = wsDATA.Range("H1").Value   ' H <- H
    
    ' Datos
    wsCONC.Range("A2").Resize(lastRowMap - 1).Value = wsDATA.Range("E2").Resize(lastRowMap - 1).Value
    wsCONC.Range("B2").Resize(lastRowMap - 1).Value = wsDATA.Range("D2").Resize(lastRowMap - 1).Value
    wsCONC.Range("D2").Resize(lastRowMap - 1).Value = wsDATA.Range("K2").Resize(lastRowMap - 1).Value
    wsCONC.Range("F2").Resize(lastRowMap - 1).Value = wsDATA.Range("F2").Resize(lastRowMap - 1).Value
    wsCONC.Range("G2").Resize(lastRowMap - 1).Value = wsDATA.Range("G2").Resize(lastRowMap - 1).Value
    wsCONC.Range("H2").Resize(lastRowMap - 1).Value = wsDATA.Range("H2").Resize(lastRowMap - 1).Value
    
    MsgBox "Listo: columnas mapeadas en CONCILIACIÓN.", vbInformation
    
TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub

' Helper: limpiar hoja
Private Sub ClearSheetCompletely(ByVal ws As Worksheet)
    On Error Resume Next
    If ws.AutoFilterMode Then ws.AutoFilterMode = False
    ws.Cells.EntireRow.Hidden = False
    ws.Cells.EntireColumn.Hidden = False
    ws.Cells.UnMerge
    ws.Cells.FormatConditions.Delete
    ws.Cells.Clear
    On Error GoTo 0
End Sub