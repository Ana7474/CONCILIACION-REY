Option Explicit

Public Sub Import_CSV_To_DATA()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wbCSV As Workbook, wsCSV As Worksheet
    Dim wsDATA As Worksheet, wsCONC As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim i As Long
    Dim valA As String, s As String, p As Long, d As Variant

    ' Hojas
    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "No se encontraron las hojas (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    ' 1) Limpiar DATA y CONCILIACIÓN
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear

    ' 2) Seleccionar archivo CSV
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Seleccionar archivo CSV"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With

    ' 3) Abrir CSV y pegar en DATA!A1
    Set wbCSV = Workbooks.Open(Filename:=filePath)
    Set wsCSV = wbCSV.Sheets(1)

    lastRow = wsCSV.Cells(wsCSV.Rows.Count, "A").End(xlUp).Row
    lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column

    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")

    wbCSV.Close SaveChanges:=False

    ' 4) Eliminar filas donde A = "Failed"
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    Dim iRow As Long
    For iRow = lastRow To 2 Step -1
        valA = Trim$(UCase$(CStr(wsDATA.Cells(iRow, "A").Value)))
        If valA = "FAILED" Then
            wsDATA.Rows(iRow).Delete
        End If
    Next iRow

    ' 5) Limpiar fechas en columna E (quitar hora, dejar dd/mm/yyyy como Short Date)
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "E").End(xlUp).Row
    For i = 2 To lastRow
        s = Trim$(CStr(wsDATA.Cells(i, "E").Value))
        If Len(s) > 0 Then
            p = InStr(s, " ")
            If p > 0 Then s = Left$(s, p - 1)
            On Error Resume Next
            d = CDate(s)
            On Error GoTo 0
            If IsDate(d) Then
                wsDATA.Cells(i, "E").Value = DateValue(d)
            End If
        End If
    Next i
    If lastRow >= 2 Then
        wsDATA.Range("E2:E" & lastRow).NumberFormat = "Short Date"
    End If

    MsgBox "Listo: CSV importado en DATA, filas 'Failed' eliminadas, fechas en E normalizadas.", vbInformation

TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub