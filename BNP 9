Sub CleanImportAndCopy_AtoH()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wbCSV As Workbook, wsCSV As Worksheet
    Dim wsDATA As Worksheet, wsCONC As Worksheet
    Dim lastRowDATA As Long, lastRowCONC As Long
    Dim i As Long, s As String, p As Long
    Dim tmpVal As Variant
    Dim bVal As String

    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    On Error GoTo 0
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "Required sheets not found (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    ' 1) Clean both sheets
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear

    ' 2) Ask for CSV
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Select a CSV file"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With

    ' 3) Open CSV and paste into DATA
    Set wbCSV = Workbooks.Open(filePath)
    Set wsCSV = wbCSV.Sheets(1)

    With wsCSV
        lastRowDATA = .Cells(.Rows.Count, "A").End(xlUp).Row
        .Range(.Cells(1, 1), .Cells(lastRowDATA, "H")).Copy wsDATA.Range("A1")
    End With

    wbCSV.Close SaveChanges:=False

    ' 4) Copy A:H from DATA -> A:H in CONCILIACIÓN
    wsDATA.Range("A1", wsDATA.Cells(lastRowDATA, "H")).Copy
    wsCONC.Range("A1").PasteSpecial xlPasteAll
    Application.CutCopyMode = False

    ' 5) Normalize dates
    lastRowCONC = wsCONC.Cells(wsCONC.Rows.Count, "A").End(xlUp).Row
    If lastRowCONC >= 2 Then
        For i = 2 To lastRowCONC
            ' --- Column G ---
            If Len(wsCONC.Cells(i, "G").Value) > 0 Then
                If IsDate(wsCONC.Cells(i, "G").Value) Then
                    wsCONC.Cells(i, "G").Value = DateValue(wsCONC.Cells(i, "G").Value)
                Else
                    s = CStr(wsCONC.Cells(i, "G").Value)
                    p = InStr(s, " ")
                    If p > 0 Then s = Left$(s, p - 1)
                    s = Replace(Replace(s, ".", "/"), "-", "/")
                    On Error Resume Next
                    wsCONC.Cells(i, "G").Value = DateValue(CDate(s))
                    On Error GoTo 0
                End If
            End If

            ' --- Column H ---
            If Len(wsCONC.Cells(i, "H").Value) > 0 Then
                If IsDate(wsCONC.Cells(i, "H").Value) Then
                    wsCONC.Cells(i, "H").Value = DateValue(wsCONC.Cells(i, "H").Value)
                Else
                    s = Replace(Replace(CStr(wsCONC.Cells(i, "H").Value), ".", "/"), "-", "/")
                    On Error Resume Next
                    wsCONC.Cells(i, "H").Value = DateValue(CDate(s))
                    On Error GoTo 0
                End If
            End If
        Next i

        wsCONC.Range("G2:G" & lastRowCONC).NumberFormat = "[$-en-US]dd-mmm-yyyy"
        wsCONC.Range("H2:H" & lastRowCONC).NumberFormat = "[$-en-US]dd-mmm-yyyy"
    End If

    ' 6) If C = CAD, swap D and E, and flip B
    For i = 2 To lastRowCONC
        If UCase$(Trim$(wsCONC.Cells(i, "C").Value)) = "CAD" Then
            ' Swap D and E
            tmpVal = wsCONC.Cells(i, "D").Value
            wsCONC.Cells(i, "D").Value = wsCONC.Cells(i, "E").Value
            wsCONC.Cells(i, "E").Value = tmpVal

            ' Flip B between S and B
            bVal = UCase$(Trim$(wsCONC.Cells(i, "B").Value))
            If bVal = "S" Then
                wsCONC.Cells(i, "B").Value = "B"
            ElseIf bVal = "B" Then
                wsCONC.Cells(i, "B").Value = "S"
            End If
        End If
    Next i

    ' 7) Format D and E with commas and 2 decimals
    wsCONC.Range("D2:D" & lastRowCONC).NumberFormat = "#,##0.00"
    wsCONC.Range("E2:E" & lastRowCONC).NumberFormat = "#,##0.00"

    ' 8) Delete rows with column E empty
    For i = lastRowCONC To 2 Step -1
        If Trim(wsCONC.Cells(i, "E").Value) = "" Then
            wsCONC.Rows(i).Delete
        End If
    Next i

    MsgBox "Done: CSV imported, A:H copied, dates normalized, CAD rows adjusted, D/E formatted, and empty E rows deleted.", vbInformation

TidyExit:
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub