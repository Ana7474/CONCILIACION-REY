Sub ImportCSV_ProcessDATA_To_CONCILIACION()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wbCSV As Workbook
    Dim wsCSV As Worksheet, wsDATA As Worksheet, wsCONC As Worksheet
    Dim lastRow As Long, lastCol As Long
    Dim i As Long

    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "Required sheets not found (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    ' 1) Clean both sheets
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear

    ' 2) Ask for a CSV file
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Select a CSV file"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With

    ' 3) Open the CSV and copy all to DATA
    Set wbCSV = Workbooks.Open(filePath)
    Set wsCSV = wbCSV.Sheets(1)

    lastRow = wsCSV.Cells(wsCSV.Rows.Count, "A").End(xlUp).Row
    lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column

    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")
    wbCSV.Close SaveChanges:=False

    ' 4) Keep only rows with "Executed" in column A
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    For i = lastRow To 2 Step -1
        If UCase$(Trim$(wsDATA.Cells(i, "A").Value)) <> "EXECUTED" Then
            wsDATA.Rows(i).Delete
        End If
    Next i

    ' 5) Paste selected columns into CONCILIACIÓN in new order, KEEPING HEADERS
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "No Executed rows found in DATA.", vbExclamation
        GoTo TidyExit
    End If

    ' Copy headers from DATA (row 1)
    wsCONC.Range("A1").Value = wsDATA.Range("G1").Value   ' G -> A
    wsCONC.Range("B1").Value = wsDATA.Range("H1").Value   ' H -> B
    wsCONC.Range("C1").Value = wsDATA.Range("I1").Value   ' I -> C
    wsCONC.Range("D1").Value = wsDATA.Range("J1").Value   ' J -> D
    wsCONC.Range("E1").Value = wsDATA.Range("N1").Value   ' N -> E
    wsCONC.Range("F1").Value = wsDATA.Range("K1").Value   ' K -> F
    wsCONC.Range("G1").Value = wsDATA.Range("E1").Value   ' E -> G
    wsCONC.Range("H1").Value = wsDATA.Range("L1").Value   ' L -> H

    ' Bulk copy the columns (faster & cleaner than looping)
    wsCONC.Range("A2").Resize(lastRow - 1, 1).Value = wsDATA.Range("G2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("B2").Resize(lastRow - 1, 1).Value = wsDATA.Range("H2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("C2").Resize(lastRow - 1, 1).Value = wsDATA.Range("I2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("D2").Resize(lastRow - 1, 1).Value = wsDATA.Range("J2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("E2").Resize(lastRow - 1, 1).Value = wsDATA.Range("N2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("F2").Resize(lastRow - 1, 1).Value = wsDATA.Range("K2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("G2").Resize(lastRow - 1, 1).Value = wsDATA.Range("E2").Resize(lastRow - 1, 1).Value
    wsCONC.Range("H2").Resize(lastRow - 1, 1).Value = wsDATA.Range("L2").Resize(lastRow - 1, 1).Value

    MsgBox "CSV imported, kept Executed rows, and pasted reordered columns WITH HEADERS into CONCILIACIÓN.", vbInformation

TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub