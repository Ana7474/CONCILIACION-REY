Sub ImportCSV_ProcessDATA_To_CONCILIACION()
    Dim fd As FileDialog
    Dim filePath As String
    Dim wbCSV As Workbook
    Dim wsCSV As Worksheet, wsDATA As Worksheet, wsCONC As Worksheet
    Dim lastRow As Long, lastCol As Long, lastRowCONC As Long
    Dim i As Long, s As String, p As Long, d As Variant
    Dim tmpVal As Variant, bVal As String

    On Error Resume Next
    Set wsDATA = ThisWorkbook.Sheets("DATA")
    Set wsCONC = ThisWorkbook.Sheets("CONCILIACIÓN")
    If wsCONC Is Nothing Then Set wsCONC = ThisWorkbook.Sheets("CONCILIACION")
    On Error GoTo 0
    If wsDATA Is Nothing Or wsCONC Is Nothing Then
        MsgBox "Required sheets not found (DATA / CONCILIACIÓN).", vbCritical
        Exit Sub
    End If

    Application.ScreenUpdating = False
    Application.EnableEvents = False

    ' 1) Clean both sheets
    wsDATA.Cells.Clear
    wsCONC.Cells.Clear

    ' 2) Ask for a CSV file
    Set fd = Application.FileDialog(msoFileDialogFilePicker)
    With fd
        .Title = "Select a CSV file"
        .Filters.Clear
        .Filters.Add "CSV Files", "*.csv"
        .AllowMultiSelect = False
        If .Show <> -1 Then GoTo TidyExit
        filePath = .SelectedItems(1)
    End With

    ' 3) Open the CSV and copy all to DATA
    Set wbCSV = Workbooks.Open(filePath)
    Set wsCSV = wbCSV.Sheets(1)

    lastRow = wsCSV.Cells(wsCSV.Rows.Count, "A").End(xlUp).Row
    lastCol = wsCSV.Cells(1, wsCSV.Columns.Count).End(xlToLeft).Column

    wsCSV.Range(wsCSV.Cells(1, 1), wsCSV.Cells(lastRow, lastCol)).Copy wsDATA.Range("A1")
    wbCSV.Close SaveChanges:=False

    ' 4) Keep only rows with "Executed" in column A
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    For i = lastRow To 2 Step -1
        If UCase$(Trim$(wsDATA.Cells(i, "A").Value)) <> "EXECUTED" Then
            wsDATA.Rows(i).Delete
        End If
    Next i

    ' 5) Paste selected columns into CONCILIACIÓN in new order, KEEPING HEADERS
    lastRow = wsDATA.Cells(wsDATA.Rows.Count, "A").End(xlUp).Row
    If lastRow < 2 Then
        MsgBox "No Executed rows found in DATA.", vbExclamation
        GoTo TidyExit
    End If

    ' Copy headers
    wsCONC.Range("A1").Value = wsDATA.Range("G1").Value   ' G -> A
    wsCONC.Range("B1").Value = wsDATA.Range("H1").Value   ' H -> B
    wsCONC.Range("C1").Value = wsDATA.Range("I1").Value   ' I -> C
    wsCONC.Range("D1").Value = wsDATA.Range("J1").Value   ' J -> D
    wsCONC.Range("E1").Value = wsDATA.Range("N1").Value   ' N -> E
    wsCONC.Range("F1").Value = wsDATA.Range("K1").Value   ' K -> F
    wsCONC.Range("G1").Value = wsDATA.Range("E1").Value   ' E -> G
    wsCONC.Range("H1").Value = wsDATA.Range("L1").Value   ' L -> H

    ' Copy data (bulk)
    wsCONC.Range("A2").Resize(lastRow - 1).Value = wsDATA.Range("G2").Resize(lastRow - 1).Value
    wsCONC.Range("B2").Resize(lastRow - 1).Value = wsDATA.Range("H2").Resize(lastRow - 1).Value
    wsCONC.Range("C2").Resize(lastRow - 1).Value = wsDATA.Range("I2").Resize(lastRow - 1).Value
    wsCONC.Range("D2").Resize(lastRow - 1).Value = wsDATA.Range("J2").Resize(lastRow - 1).Value
    wsCONC.Range("E2").Resize(lastRow - 1).Value = wsDATA.Range("N2").Resize(lastRow - 1).Value
    wsCONC.Range("F2").Resize(lastRow - 1).Value = wsDATA.Range("K2").Resize(lastRow - 1).Value
    wsCONC.Range("G2").Resize(lastRow - 1).Value = wsDATA.Range("E2").Resize(lastRow - 1).Value
    wsCONC.Range("H2").Resize(lastRow - 1).Value = wsDATA.Range("L2").Resize(lastRow - 1).Value

    ' 6) Clean dates in column G of CONCILIACIÓN (strip time like "a. m." / "p. m.")
    lastRowCONC = wsCONC.Cells(wsCONC.Rows.Count, "A").End(xlUp).Row
    For i = 2 To lastRowCONC
        s = CStr(wsCONC.Cells(i, "G").Value)
        If Len(s) > 0 Then
            p = InStr(s, " ")
            If p > 0 Then s = Left$(s, p - 1)
            On Error Resume Next
            d = CDate(s)
            On Error GoTo 0
            If IsDate(d) Then wsCONC.Cells(i, "G").Value = DateValue(d)
        End If
    Next i
    wsCONC.Range("G2:G" & lastRowCONC).NumberFormat = "dd/mm/yyyy"

    ' 7) CAD rule: If C = CAD, swap D/E and flip B (S <-> B)
    For i = 2 To lastRowCONC
        If UCase$(Trim$(wsCONC.Cells(i, "C").Value)) = "CAD" Then
            ' Swap D and E
            tmpVal = wsCONC.Cells(i, "D").Value
            wsCONC.Cells(i, "D").Value = wsCONC.Cells(i, "E").Value
            wsCONC.Cells(i, "E").Value = tmpVal

            ' Flip B between S and B
            bVal = UCase$(Trim$(wsCONC.Cells(i, "B").Value))
            If bVal = "S" Then
                wsCONC.Cells(i, "B").Value = "B"
            ElseIf bVal = "B" Then
                wsCONC.Cells(i, "B").Value = "S"
            End If
        End If
    Next i

    MsgBox "Done: CSV imported, Executed rows kept, columns reordered, dates cleaned, and CAD rule applied.", vbInformation

TidyExit:
    Application.CutCopyMode = False
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub